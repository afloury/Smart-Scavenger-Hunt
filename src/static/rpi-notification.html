<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <style type="text/css">
            html, body {
                width: 100%;
                height: 100%;

                margin: 0;
                padding: 0;
            }

            h1, h2, h3, h4, h5, h6 {
                vertical-align: middle;
                text-align: center;
            }

            #alert_container {
                position: fixed;
                top: 33%;

                width: 100%;
                height: auto;

                background-color: #e89c38;
            }

            div.notification_line {
                position: relative;

                width: 100%;
                height: 0px;

                opacity: 0;

                border-bottom: 1px solid rgba(0, 0, 0, 0.5);
            }

            div.notification_line.won {
                background-color: #6ab04f;
            }

            div.notification_line.lost {
                background-color: #d4565b;
            }

            div.notification_line h2, div.notification_line h3, div.notification_line h4 {
                margin: 0;
                padding: 0;
            }
        </style>
    </head>
    <body>
        <link href="libraries/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">

        <div id="alert_container">
            <h2>Connexion en cours</h2>
            <h3>Veuillez patienter...</h3>
        </div>

        <section id="notification_container">

        </section>

        <script src="libraries/jquery/js/jquery-3.2.1.min.js"></script>
        <script src="libraries/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
        <script type="text/javascript">
            $(function() {
                var polling_url = '/rpi-notification/';

                function display_notification(team, message, score, has_won) {
                    $('#notification_container').prepend(
                        $('<div/>')
                            .addClass('notification_line').addClass(has_won ? 'won' : 'lost')
                            .animate({'height': '160px', 'opacity': 1}, 650, function() {
                                var that = this;
                                setTimeout(function() {
                                    console.log(this);
                                    $(that).animate({'opacity': 0.5}, 400);
                                }, 2000);
                            })
                            .append('<br/>')
                            .append($('<h2/>').text('Ã‰quipe : ' + team))
                            .append('<br/>')
                            .append($('<h3/>').text(message))
                            .append('<br/>')
                            .append($('<h4/>').text('Points : ' + score))
                    );
                }

                function pop_polling() {
                    var has_finished_correctly = null;

                    $.ajax({
                        url: polling_url,
                        method: 'DELETE',
                        success: function(data) {
                            has_finished_correctly = true;
                            console.log(data);
                        },
                        error: function(data) {
                            has_finished_correctly = false;
                            console.log(data);
                        },
                        async: false
                    });

                    return has_finished_correctly;
                }

                function do_polling() {
                    $.ajax({
                        url: polling_url,
                        method: 'GET',
                        success: function(data) {
                            $('#alert_container').addClass('hidden');

                            console.log(data);

                            if (data.length === 0) {
                                setTimeout(do_polling, 500);
                                return;
                            }

                            display_notification(
                                data[0]['team'],
                                data[0]['message'],
                                data[0]['score'],
                                data[0]['has_won']
                            );

                            while (pop_polling() !== true);

                            setTimeout(function() {
                                setTimeout(do_polling, 500);
                            }, 2500);
                        },
                        error: function(data) {
                            display_notification('Erreur de connexion', 'Veuillez patientez, tentative de reconnexion en cours...', '', false);
                            setTimeout(do_polling, 2000);
                        }
                    });
                }

                do_polling();
            });
        </script>
    </body>
</html>
